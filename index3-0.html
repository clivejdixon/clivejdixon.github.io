<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Call Handler - EventBridge</title>
        <script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
        <style>
            .action-button {
                background-color: black;
                color: yellow;
                padding: 10px 20px;
                border: none;
                border-radius: 5px;
                cursor: pointer;
                font-size: 14px;
                margin-top: 0px;
            }
            
            .action-button:disabled {
                background-color: #555;
                color: #ccc;
                cursor: not-allowed;
            }
            
            .center {
                text-align: center;
            }
        </style>
    </head>
    <body>
        <div class="center">
            <button id="tsnResetButton" class="action-button" onclick="startSequence()">TSN Reset (Conference)</button>
        </div>
    
        <script>
            const CLIENT_ID = 'c7d2a0f9-cfa1-4001-aeba-a5550f690ab1';
            const ENVIRONMENT = 'euw2.pure.cloud';
            const REDIRECT_URI = 'https://clivejdixon.github.io/index3-0.html';
            const QUEUE_ID = '8e75c14e-3d97-44df-9e81-10421015f9cb';
            const SPEAK_TO_INITIAL = 'BOTH';
            const SPEAK_TO_FINAL = 'CONFERENCE';
            const WAITTIME = 1000;
            const SESSION_KEY = 'tsn_reset_session';

            // Global variables
            let eventBridgeId = null;
            let isMonitoringParticipants = false;
            let sequenceRunning = false;
            let monitoringInterval = null;
            let monitoringStartTime = null;
            let apiCallCount = 0;
            
            // Global parameters that will be set after authentication
            let gToken = null;
            let conversationId = null;
            let agentParticipantId = null;
            let customerParticipantId = null;
            let consultingUserId = null;
            let BASE_API_URL = null;

            // Session management functions
            function saveSessionData(data) {
                try {
                    const sessionData = {
                        ...data,
                        timestamp: Date.now()
                    };
                    window.sessionStorage.setItem(SESSION_KEY, JSON.stringify(sessionData));
                    console.log('[DEBUG] üíæ Session data saved');
                } catch (e) {
                    console.warn('[DEBUG] ‚ö†Ô∏è Could not save session data:', e);
                }
            }

            function loadSessionData() {
                try {
                    const data = window.sessionStorage.getItem(SESSION_KEY);
                    if (data) {
                        const parsed = JSON.parse(data);
                        console.log('[DEBUG] üìÇ Session data loaded:', parsed);
                        return parsed;
                    }
                } catch (e) {
                    console.warn('[DEBUG] ‚ö†Ô∏è Could not load session data:', e);
                }
                return null;
            }

            function clearSessionData() {
                try {
                    window.sessionStorage.removeItem(SESSION_KEY);
                    console.log('[DEBUG] üóëÔ∏è Session data cleared');
                } catch (e) {
                    console.warn('[DEBUG] ‚ö†Ô∏è Could not clear session data:', e);
                }
            }

            // Check for pending monitoring state and resume if needed
            function checkAndResumePendingMonitoring() {
                const sessionData = loadSessionData();
                if (sessionData && sessionData.pendingMonitoring) {
                    const timeSinceHold = Date.now() - sessionData.holdTimestamp;
                    const remainingWait = 58000 - timeSinceHold;
                    
                    console.log('[DEBUG] üîÑ Found pending monitoring session');
                    console.log('[DEBUG] ‚è∞ Time since hold:', Math.floor(timeSinceHold / 1000), 'seconds');
                    
                    // Disable the button while monitoring is pending or active
                    document.getElementById('tsnResetButton').disabled = true;
                    
                    if (remainingWait > 0) {
                        console.log('[DEBUG] ‚è≥ Resuming wait for', Math.floor(remainingWait / 1000), 'more seconds...');
                        setTimeout(() => {
                            console.log('[DEBUG] üåâ Starting participant monitoring (resumed)...');
                            startParticipantMonitoring();
                            // Update session to indicate monitoring is active
                            saveSessionData({
                                ...sessionData,
                                pendingMonitoring: false,
                                monitoringActive: true
                            });
                        }, remainingWait);
                    } else {
                        console.log('[DEBUG] üåâ Wait period already elapsed, starting monitoring immediately...');
                        startParticipantMonitoring();
                        saveSessionData({
                            ...sessionData,
                            pendingMonitoring: false,
                            monitoringActive: true
                        });
                    }
                } else if (sessionData && sessionData.monitoringActive) {
                    console.log('[DEBUG] üîÑ Resuming active monitoring...');
                    // Disable the button while monitoring is active
                    document.getElementById('tsnResetButton').disabled = true;
                    startParticipantMonitoring();
                }
            }

            // MAIN SEQUENCE FUNCTION
            window.startSequence = async function() {
                console.log('[DEBUG] üñ±Ô∏è TSN Reset button clicked! 74');
                
                // Disable the button when sequence starts
                document.getElementById('tsnResetButton').disabled = true;
                
                // Check if we have the required parameters
                if (!gToken || !conversationId || !agentParticipantId || !customerParticipantId || !consultingUserId) {
                    const errorMsg = 'Missing required parameters. Please ensure OAuth flow completed successfully.';
                    console.error('[DEBUG] ‚ùå', errorMsg);
                    // Re-enable button if parameters are missing
                    document.getElementById('tsnResetButton').disabled = false;
                    return;
                }
                
                // Prevent multiple sequence executions
                if (sequenceRunning) {
                    console.log('[DEBUG] ‚ö†Ô∏è Sequence already running, ignoring request');
                    return;
                }
                
                sequenceRunning = true;
                console.log('[DEBUG] üöÄ 74 Starting TSN Reset sequence...');

                try {
                    // Step 1: Try POST consult first, fallback to POST participants
                    try {
                        await makeApiCall(
                            `${BASE_API_URL}/participants/${customerParticipantId}/consult`,
                            'POST',
                            {
                                speakTo: SPEAK_TO_INITIAL,
                                destination: {
                                    queueId: QUEUE_ID
                                },
                                consultingUserId: consultingUserId
                            },
                            'STEP 1a: Creating consultation'
                        );
                    } catch (error) {
                        console.log('[DEBUG] ‚ö†Ô∏è Step 1a failed (likely already in conference), trying fallback approach...');
                        
                        try {
                            await makeApiCall(
                                `${BASE_API_URL}/participants`,
                                'POST',
                                {
                                    "participants": [{"queueId": QUEUE_ID}]
                                },
                                'STEP 1b: Adding queue to conference (fallback)'
                            );
                            console.log('[DEBUG] ‚úÖ Step 1b fallback succeeded - skipping to Step 3 (conference already active)');
                            
                            console.log('[DEBUG] ‚è≥ Waiting 1 second before final step...');
                            await sleep(WAITTIME);
                            
                            await makeApiCall(
                                `${BASE_API_URL}/participants/${agentParticipantId}`,
                                'PATCH',
                                {
                                    held: true
                                },
                                'STEP 3: Placing agent on hold'
                            );

                            // Save state for monitoring
                            saveSessionData({
                                conversationId,
                                agentParticipantId,
                                customerParticipantId,
                                consultingUserId,
                                token: gToken,
                                holdTimestamp: Date.now(),
                                pendingMonitoring: true
                            });

                            console.log('[DEBUG] ‚è≥ Starting 58-second wait...');
                            console.log('[DEBUG] ‚è∞ Wait started at:', new Date().toLocaleTimeString());
                            
                            setTimeout(() => {
                                console.log('[DEBUG] ‚è∞ Wait completed at:', new Date().toLocaleTimeString());
                                console.log('[DEBUG] üåâ Start monitoring for dropped customer...');
                                startParticipantMonitoring();
                            }, 58000);
                            
                            return;
                        } catch (fallbackError) {
                            console.log('[DEBUG] ‚ùå Both Step 1a and 1b failed');
                            throw fallbackError;
                        }
                    }

                    console.log('[DEBUG] ‚è≥ Waiting 1 second...');
                    await sleep(WAITTIME);

                    try {
                        await makeApiCall(
                            `${BASE_API_URL}/participants/${customerParticipantId}/consult`,
                            'PATCH',
                            {
                                speakTo: SPEAK_TO_FINAL,
                                consultingUserId: consultingUserId
                            },
                            'STEP 2a: Updating consultation speak mode'
                        );
                    } catch (error) {
                        console.log('[DEBUG] ‚ö†Ô∏è Step 2a failed, trying fallback approach...');
                        
                        try {
                            await makeApiCall(
                                `${BASE_API_URL}/participants`,
                                'POST',
                                {
                                    "participants": [{"queueId": QUEUE_ID}]
                                },
                                'STEP 2b: Adding queue to conference (fallback)'
                            );
                            console.log('[DEBUG] ‚úÖ Step 2b fallback succeeded');
                        } catch (fallbackError) {
                            console.log('[DEBUG] ‚ùå Both Step 2a and 2b failed');
                            throw fallbackError;
                        }
                    }

                    console.log('[DEBUG] ‚è≥ Waiting 1 second...');
                    await sleep(WAITTIME);

                    await makeApiCall(
                        `${BASE_API_URL}/participants/${agentParticipantId}`,
                        'PATCH',
                        {
                            held: true
                        },
                        'STEP 3: Placing agent on hold'
                    );
                    
                    // Save state for monitoring
                    saveSessionData({
                        conversationId,
                        agentParticipantId,
                        customerParticipantId,
                        consultingUserId,
                        token: gToken,
                        holdTimestamp: Date.now(),
                        pendingMonitoring: true
                    });

                    console.log('[DEBUG] ‚è≥ Starting 58-second wait...');
                    console.log('[DEBUG] ‚è∞ Wait started at:', new Date().toLocaleTimeString());
                    
                    setTimeout(() => {
                        console.log('[DEBUG] ‚è∞ Wait completed at:', new Date().toLocaleTimeString());
                        console.log('[DEBUG] üåâ Start monitoring for dropped customer...');
                        startParticipantMonitoring();
                    }, 58000);
                                        
                } catch (error) {
                    console.error("[DEBUG] Sequence error:", error);
                    console.log(`[DEBUG] üí• SEQUENCE FAILED: ${error.responseText || error.message}`);
                    // Re-enable button on error
                    document.getElementById('tsnResetButton').disabled = false;
                } finally {
                    sequenceRunning = false;
                }
            };

            function startParticipantMonitoring() {
                if (isMonitoringParticipants) {
                    console.log('[DEBUG] ‚ö†Ô∏è Monitoring already active');
                    return;
                }
                
                isMonitoringParticipants = true;
                monitoringStartTime = Date.now();
                apiCallCount = 0;
                console.log('[DEBUG] üîÑ Starting participant monitoring...');
                
                monitoringInterval = setInterval(async () => {
                    try {
                        const participantCount = await checkParticipantCount();
                        
                        if (participantCount < 3) {
                            const elapsedSeconds = Math.floor((Date.now() - monitoringStartTime) / 1000);
                            const totalWaitTime = 58 + (2 * apiCallCount);
                            console.log(`[DEBUG] üéØ Participant count dropped below 3 after ${elapsedSeconds} seconds (58 + ${2 * apiCallCount} = ${totalWaitTime} seconds)`);
                            await takeAgentOffHold();
                        }
                    } catch (error) {
                        console.error('[DEBUG] ‚ùå Error during monitoring:', error);
                    }
                }, 2000);
            }

            async function checkParticipantCount() {
                apiCallCount++;
                try {
                    const response = await makeApiCall(
                        `${BASE_API_URL}`,
                        'GET', 
                        null,
                        'Checking participant count'
                    );
                    
                    const activeParticipants = response.participants.filter(p => 
                        p.state === 'connected' || p.state === 'alerting'
                    );
                    
                    console.log(`[DEBUG] Current participant count: ${activeParticipants.length}`);
                    return activeParticipants.length;
                } catch (error) {
                    console.error('[DEBUG] ‚ùå Error checking participant count:', error);
                    throw error;
                }
            }

            async function takeAgentOffHold() {
                try {
                    await makeApiCall(
                        `${BASE_API_URL}/participants/${agentParticipantId}`,
                        'PATCH',
                        {
                            held: false
                        },
                        'FINAL STEP: Taking agent off hold'
                    );
                    
                    console.log('[DEBUG] üéâ Agent taken off hold - TSN Reset sequence complete!');
                    
                    // Re-enable the button after sequence is complete
                    document.getElementById('tsnResetButton').disabled = false;
                    
                    cleanupMonitoring();
                    clearSessionData();
                    
                } catch (error) {
                    console.error("[DEBUG] ‚ùå Error taking agent off hold:", error);
                    // Re-enable the button even if there's an error
                    document.getElementById('tsnResetButton').disabled = false;
                }
            }

            function cleanupMonitoring() {
                if (monitoringInterval) {
                    console.log('[DEBUG] üßπ Cleaning up participant monitoring...');
                    clearInterval(monitoringInterval);
                    monitoringInterval = null;
                }
                isMonitoringParticipants = false;
            }

            function getTokenAndStateFromHash() {
                const hash = window.location.hash.substring(1);
                const params = new URLSearchParams(hash);
                const token = params.get('access_token');
                const state = params.get('state');

                console.log('[DEBUG] OAuth Callback Details:', {
                    hasHash: !!window.location.hash,
                    token: token ? 'Present' : 'Missing',
                    state: state || 'No state found'
                });

                if (state) {
                    try {
                     const decodedState = decodeURIComponent(state);
                     const parsed = JSON.parse(atob(decodedState));
            
                     console.log('[DEBUG] Decoded State:', {
                         conversationId: parsed.conversationId,
                            agentParticipantId: parsed.agentParticipantId,
                            customerParticipantId: parsed.customerParticipantId,
                         consultingUserId: parsed.consultingUserId
                        });

                        return {
                            token, 
                            conversationId: parsed.conversationId,
                            agentParticipantId: parsed.agentParticipantId,
                         customerParticipantId: parsed.customerParticipantId,
                            consultingUserId: parsed.consultingUserId
                        };
                    } catch (e) {
                     console.error('[DEBUG] State Decoding Error:', e);
                 }
             }

                return { token: null };
            }

            function getParametersFromUrl() {
                const urlParams = new URLSearchParams(window.location.search);
                const params = {
                conversationId: urlParams.get('conversationId'),
                agentParticipantId: urlParams.get('agentParticipantId'),
                customerParticipantId: urlParams.get('customerParticipantId'),
                consultingUserId: urlParams.get('consultingUserId')
                };

                console.log('[DEBUG] Raw URL Parameters:', {
                    fullSearch: window.location.search,
                    parsedParams: params
                });

                return params;
            }

            function sleep(ms) {
                return new Promise(resolve => setTimeout(resolve, ms));
            }

            async function makeApiCall(endpoint, method, data, description = '') {
                try {
                    console.log(`[DEBUG] ${description} - ${method} ${endpoint}`);
                    
                    const response = await $.ajax({
                        url: endpoint,
                        type: method,
                        beforeSend: function(xhr) {
                            xhr.setRequestHeader('Authorization', 'Bearer ' + gToken);
                        },
                        data: JSON.stringify(data),
                        contentType: 'application/json'
                    });
                    
                    console.log(`[DEBUG] ‚úÖ ${description} - SUCCESS`);
                    return response;
                } catch (error) {
                    console.error(`[DEBUG] ‚ùå ${description} - ERROR:`, error);
                    console.error(`[DEBUG] ‚ùå ${description} - ERROR:`, {
                        status: error.status,
                     statusText: error.statusText,
                     responseText: error.responseText,
                     readyState: error.readyState,
                     responseHeaders: error.getAllResponseHeaders()
                 });
                 throw error;
                }
            }

            // Initialize the application
            (function initializeApp() {
                console.log('[DEBUG] üöÄ Application starting...');
                
                // First check if we have saved session data
                const sessionData = loadSessionData();
                if (sessionData && sessionData.token) {
                    console.log('[DEBUG] üìÇ Restoring from session data...');
                    gToken = sessionData.token;
                    conversationId = sessionData.conversationId;
                    agentParticipantId = sessionData.agentParticipantId;
                    customerParticipantId = sessionData.customerParticipantId;
                    consultingUserId = sessionData.consultingUserId;
                    BASE_API_URL = `https://api.${ENVIRONMENT}/api/v2/conversations/calls/${conversationId}`;
                    
                    console.log("[DEBUG] ‚úÖ Session restored");
                    console.log(`[DEBUG] üìã Conversation ID: ${conversationId}`);
                    console.log(`[DEBUG] üë§ Agent ID: ${agentParticipantId.substring(0,8)}...`);
                    console.log(`[DEBUG] üìû Customer ID: ${customerParticipantId.substring(0,8)}...`);
                    console.log('[DEBUG] ‚úÖ Ready for TSN Reset - Button is active!');
                    
                    // Check if we need to resume monitoring and update button state
                    setTimeout(() => {
                        checkAndResumePendingMonitoring();
                        
                        // Disable button if monitoring is active or pending
                        if (sessionData.pendingMonitoring || sessionData.monitoringActive) {
                            document.getElementById('tsnResetButton').disabled = true;
                        }
                    }, 1000);
                    return;
                }
                
                // No session data, proceed with OAuth flow
                let { token, conversationId: convId, agentParticipantId: agentId, customerParticipantId: customerId, consultingUserId: consultId } = getTokenAndStateFromHash();

                if (!token) {
                    console.log('[DEBUG] üîë No token found, checking URL parameters...');
                    
                    const urlParams = getParametersFromUrl();
                    
                    if (!urlParams.conversationId || !urlParams.agentParticipantId || !urlParams.customerParticipantId || !urlParams.consultingUserId) {
                        const errorMsg = "Missing parameters in the URL. Cannot continue.";
                        console.log(`[DEBUG] ‚ùå ${errorMsg}`);
                        alert(errorMsg);
                        return;
                    }

                    const state = btoa(JSON.stringify({
                        conversationId: urlParams.conversationId,
                        agentParticipantId: urlParams.agentParticipantId,
                        customerParticipantId: urlParams.customerParticipantId,
                        consultingUserId: urlParams.consultingUserId                
                    }));
                    console.log("[DEBUG] üîÑ Redirecting to OAuth...");

                    const authUrl = `https://login.${ENVIRONMENT}/oauth/authorize?` + 
                        $.param({
                            response_type: 'token',
                            client_id: CLIENT_ID,
                            redirect_uri: REDIRECT_URI,
                            state: state
                        });
                    
                    setTimeout(() => {
                        window.location.replace(authUrl);
                    }, 1000);
                } else {
                    if (!convId || !agentId || !customerId || !consultId) {
                        const errorMsg = "Missing parameters in OAuth callback. Cannot continue.";
                        console.log(`[DEBUG] ‚ùå ${errorMsg}`);
                        alert(errorMsg);
                        return;
                    }

                    gToken = token;
                    conversationId = convId;
                    agentParticipantId = agentId;
                    customerParticipantId = customerId;
                    consultingUserId = consultId;
                    BASE_API_URL = `https://api.${ENVIRONMENT}/api/v2/conversations/calls/${conversationId}`;

                    // Save to session storage for persistence
                    saveSessionData({
                        token: gToken,
                        conversationId,
                        agentParticipantId,
                        customerParticipantId,
                        consultingUserId
                    });

                    console.log("[DEBUG] ‚úÖ Authentication complete");
                    console.log(`[DEBUG] üìã Conversation ID: ${conversationId}`);
                    console.log(`[DEBUG] üë§ Agent ID: ${agentParticipantId.substring(0,8)}...`);
                    console.log(`[DEBUG] üìû Customer ID: ${customerParticipantId.substring(0,8)}...`);
                    console.log('[DEBUG] ‚úÖ Ready for TSN Reset - Button is active!');
                    
                    // DON'T clear the hash - let it stay to avoid page reload
                    console.log('[DEBUG] üîí Keeping hash to prevent reload');
                }
            })();

            window.addEventListener('beforeunload', function(event) {
                if (isMonitoringParticipants) {
                    console.log('[DEBUG] ‚ö†Ô∏è Page unload during monitoring - session data preserved');
                }
            });
        </script>
    </body>
</html>
